<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RentMatrix AI Triage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1021;
      --card: #161d34;
      --text: #e8ecf7;
      --muted: #93a1c6;
      --accent: #5b8dff;
      --accent-2: #5df4d7;
      --danger: #ff6b6b;
      --warn: #ffb65b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0d1a 0%, #0c1328 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    .page { max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 24px; }
    h2 { margin: 0 0 16px; font-size: 17px; color: var(--accent); }
    .subtitle { color: var(--muted); margin-bottom: 24px; font-size: 14px; }

    .panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .steps {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      flex: 1;
      transition: all 0.3s;
    }
    .step.active {
      background: rgba(91, 141, 255, 0.15);
      border-color: var(--accent);
    }
    .step.done {
      background: rgba(93, 244, 215, 0.1);
      border-color: var(--accent-2);
    }
    .step.disabled { opacity: 0.4; }
    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
    .step.active .step-num { background: var(--accent); color: #0b1021; }
    .step.done .step-num { background: var(--accent-2); color: #0b1021; }
    .step-text strong { display: block; font-size: 14px; }
    .step-text span { color: var(--muted); font-size: 12px; }

    label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
    input, textarea {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14px;
      margin-bottom: 12px;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91, 141, 255, 0.15);
    }
    textarea { min-height: 100px; resize: vertical; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    button {
      border: none;
      border-radius: 10px;
      padding: 14px 24px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.1s, opacity 0.2s;
    }
    button:active:not(:disabled) { transform: scale(0.98); }
    button.primary {
      background: linear-gradient(135deg, #5b8dff, #5df4d7);
      color: #0b1021;
      width: 100%;
    }
    button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .toggle-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.03);
      color: var(--muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .toggle-btn.active {
      background: rgba(91, 141, 255, 0.2);
      border-color: rgba(91, 141, 255, 0.5);
      color: var(--accent);
    }

    .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0; }
    .result-card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 12px;
      padding: 14px;
    }
    .result-card h3 { margin: 0 0 8px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .result-card p { margin: 0; font-size: 12px; color: var(--muted); line-height: 1.5; }

    .pill {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 11px;
    }
    .pill.emergency { background: rgba(255, 50, 50, 0.2); color: #ff6b6b; }
    .pill.high { background: rgba(255, 107, 107, 0.16); color: #ff8b8b; }
    .pill.medium { background: rgba(255, 182, 91, 0.16); color: #ffc187; }
    .pill.low { background: rgba(93, 244, 215, 0.12); color: #7df2dc; }
    .pill.info { background: rgba(91, 141, 255, 0.14); color: #9bc2ff; }

    .vendor-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .vendor-card.primary {
      border-color: rgba(93, 244, 215, 0.5);
      background: rgba(93, 244, 215, 0.08);
    }
    .vendor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .vendor-name { font-size: 18px; font-weight: 600; }
    .vendor-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .vendor-badge.primary { background: rgba(93, 244, 215, 0.2); color: var(--accent-2); }
    .vendor-badge.backup { background: rgba(255, 182, 91, 0.15); color: var(--warn); }

    .time-slots { margin-top: 12px; }
    .time-slots label { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .time-badge {
      display: inline-block;
      padding: 6px 10px;
      background: rgba(93, 244, 215, 0.15);
      border: 1px solid rgba(93, 244, 215, 0.3);
      border-radius: 8px;
      font-size: 12px;
      color: var(--accent-2);
      margin-right: 6px;
      margin-top: 4px;
    }
    .no-match { color: var(--warn); font-size: 12px; }

    .status { font-size: 13px; color: var(--muted); margin-top: 12px; text-align: center; }
    .status.error { color: var(--danger); }
    .status.success { color: var(--accent-2); }

    .hidden { display: none !important; }
    .muted { color: var(--muted); }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.08);
      margin: 20px 0;
    }

    .info-box {
      background: rgba(91, 141, 255, 0.1);
      border: 1px solid rgba(91, 141, 255, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      color: var(--accent);
      margin-bottom: 16px;
    }

    @media (max-width: 640px) {
      .row, .row-3, .results-grid { grid-template-columns: 1fr; }
      .steps { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>RentMatrix AI Maintenance Triage</h1>
    <p class="subtitle">Describe your issue, pick your available times, and we'll match you with the best vendor.</p>

    <!-- Steps -->
    <div class="steps">
      <div class="step active" id="step1-indicator">
        <div class="step-num">1</div>
        <div class="step-text">
          <strong>Describe Issue</strong>
          <span>What's the problem?</span>
        </div>
      </div>
      <div class="step disabled" id="step2-indicator">
        <div class="step-num">2</div>
        <div class="step-text">
          <strong>Your Availability</strong>
          <span>When are you free?</span>
        </div>
      </div>
      <div class="step disabled" id="step3-indicator">
        <div class="step-num">3</div>
        <div class="step-text">
          <strong>Vendor Match</strong>
          <span>We find the best fit</span>
        </div>
      </div>
    </div>

    <!-- Step 1: Description -->
    <div class="panel" id="step1-panel">
      <h2>Step 1: What's the problem?</h2>

      <label>Describe the maintenance issue *</label>
      <textarea id="description" placeholder="Example: Water is leaking from the bathroom ceiling. It started this morning and there's a growing water stain."></textarea>

      <div>
        <label>Your Location (for weather context)</label>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <button type="button" class="toggle-btn active" id="toggle-text">City/Address</button>
          <button type="button" class="toggle-btn" id="toggle-gps">Use My Location</button>
        </div>
        <div id="location-text-input">
          <input id="location" type="text" placeholder="e.g., Boston, MA" style="margin-bottom: 0;">
        </div>
        <div id="location-coords-input" style="display: none;">
          <div class="row">
            <input id="location-lat" type="text" placeholder="Latitude" style="margin-bottom: 0;" readonly>
            <input id="location-lon" type="text" placeholder="Longitude" style="margin-bottom: 0;" readonly>
          </div>
        </div>
        <div id="location-status" style="display: none; font-size: 12px; margin-top: 8px;"></div>
      </div>

      <div style="margin-top: 16px;">
        <button class="primary" id="submit-step1">Analyze Issue</button>
      </div>
      <div class="status" id="step1-status"></div>
    </div>

    <!-- Triage Results (shown after step 1) -->
    <div class="panel hidden" id="triage-results">
      <h2>Analysis Results</h2>
      <div class="results-grid">
        <div class="result-card">
          <h3>Classification <span class="pill info" id="result-severity">--</span> <span class="pill info" id="result-trade">--</span></h3>
          <p id="result-reasoning">--</p>
        </div>
        <div class="result-card">
          <h3>Priority <span class="pill info" id="result-priority">--</span></h3>
          <p id="result-sla">Response: -- | Resolution: --</p>
        </div>
      </div>
    </div>

    <!-- Step 2: Time Slots -->
    <div class="panel hidden" id="step2-panel">
      <h2>Step 2: When are you available?</h2>
      <p class="muted" style="margin-top: -10px; margin-bottom: 16px;">
        We detected this is a <strong id="detected-trade">--</strong> issue. Please provide 3 time slots when you're available for the repair.
      </p>

      <div class="info-box">
        Format: Day + Time Range (e.g., "Monday 09:00-12:00")
      </div>

      <div class="row-3">
        <div>
          <label>Time Slot 1 *</label>
          <input id="time1" type="text" placeholder="Monday 09:00-12:00" style="margin-bottom: 0;">
        </div>
        <div>
          <label>Time Slot 2 *</label>
          <input id="time2" type="text" placeholder="Wednesday 14:00-17:00" style="margin-bottom: 0;">
        </div>
        <div>
          <label>Time Slot 3 *</label>
          <input id="time3" type="text" placeholder="Friday 10:00-15:00" style="margin-bottom: 0;">
        </div>
      </div>

      <div style="margin-top: 16px;">
        <button class="primary" id="submit-step2">Find Best Vendor</button>
      </div>
      <div class="status" id="step2-status"></div>
    </div>

    <!-- Step 3: Vendor Results -->
    <div class="panel hidden" id="step3-panel">
      <h2>Step 3: Your Matched Vendors</h2>
      <p class="muted" id="vendor-summary"></p>
      <div id="vendor-list"></div>

      <div class="divider"></div>
      <button class="secondary" id="start-over" style="width: 100%;">Submit Another Request</button>
    </div>

    <!-- Quotation Workflow -->
    <div class="panel" id="quotation-panel">
      <h2>Vendor Quotations (Image Upload + Comparison)</h2>
      <p class="muted" style="margin-top: -10px; margin-bottom: 16px;">
        Vendors can upload quotation images. Analyze them, store the IDs, then compare any three to get a recommendation.
      </p>

      <div class="row" style="gap: 16px;">
        <!-- Submit Quotation -->
        <div>
          <h3 style="margin-top:0;">1) Submit Quotation</h3>
          <label>Request ID *</label>
          <input id="quote-request-id" type="text" placeholder="REQ-2024-001">

          <label>Vendor ID *</label>
          <input id="quote-vendor-id" type="text" placeholder="VND-PL-001">

          <label>Vendor Notes (optional)</label>
          <textarea id="quote-vendor-notes" placeholder="Any notes from vendor"></textarea>

          <label>Quotation Images (PNG/JPG, up to 10)</label>
          <input id="quote-images" type="file" accept="image/*" multiple>

          <button class="primary" id="quote-submit-btn" style="margin-top: 8px;">Analyze Quotation</button>
          <div class="status" id="quote-submit-status"></div>

          <div class="result-card" id="quote-submit-result" style="margin-top:12px; display:none;">
            <h3>Submission Saved</h3>
            <p id="quote-result-id"></p>
            <p id="quote-result-price"></p>
            <p id="quote-result-timeline"></p>
            <p id="quote-result-warranty"></p>
          </div>
        </div>

        <!-- Compare Quotations -->
        <div>
          <h3 style="margin-top:0;">2) Compare 3 Quotations</h3>
          <label>Request ID *</label>
          <input id="compare-request-id" type="text" placeholder="REQ-2024-001">

          <label>Quotation IDs (pick 3)</label>
          <input id="compare-id-1" type="text" placeholder="QUO-XXXXXX">
          <input id="compare-id-2" type="text" placeholder="QUO-XXXXXX">
          <input id="compare-id-3" type="text" placeholder="QUO-XXXXXX">

          <button class="primary" id="compare-btn" style="margin-top: 8px;">Compare Quotations</button>
          <div class="status" id="compare-status"></div>

          <div class="result-card" id="compare-result" style="margin-top:12px; display:none;">
            <h3>Recommendation</h3>
            <p id="compare-recommend"></p>
            <p id="compare-summary"></p>
            <p id="compare-flags" class="muted"></p>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="info-box" id="quote-stored-list" style="display:none;">
        <strong>Stored Quotations:</strong>
        <div id="quote-list-body" style="margin-top:8px; font-size:12px;"></div>
      </div>
    </div>

    <!-- API Config (collapsible) -->
    <details style="margin-top: 20px;">
      <summary style="cursor: pointer; color: var(--muted); font-size: 12px;">API Settings</summary>
      <div style="margin-top: 10px;">
        <label style="font-size: 12px;">API Endpoint</label>
        <input id="api-url" type="text" value="http://localhost:8000" style="font-size: 12px;">
      </div>
    </details>
  </div>

  <script>
    // State
    let currentTrade = null;
    let triageData = null;
    let locationMode = 'text';
    let storedQuotations = []; // {quotation_id, request_id, vendor_id, extracted_data}

    // Mock vendors (in real app, these come from backend)
    const mockVendors = [
      {
        vendor_id: "V001",
        company_name: "QuickFix Plumbing 24/7",
        primary_trade: "PLUMBING",
        phone: "555-0101",
        availability: ["Monday 08:00-18:00", "Tuesday 08:00-18:00", "Wednesday 08:00-18:00", "Thursday 08:00-18:00", "Friday 08:00-18:00"]
      },
      {
        vendor_id: "V002",
        company_name: "Reliable Plumbing Services",
        primary_trade: "PLUMBING",
        phone: "555-0102",
        availability: ["Monday 09:00-17:00", "Wednesday 09:00-17:00", "Friday 09:00-17:00"]
      },
      {
        vendor_id: "V003",
        company_name: "Budget Plumbing Co",
        primary_trade: "PLUMBING",
        phone: "555-0103",
        availability: ["Tuesday 10:00-16:00", "Thursday 10:00-16:00"]
      },
      {
        vendor_id: "V004",
        company_name: "Elite Electric Services",
        primary_trade: "ELECTRICAL",
        phone: "555-0201",
        availability: ["Monday 07:00-19:00", "Tuesday 07:00-19:00", "Wednesday 07:00-19:00", "Thursday 07:00-19:00", "Friday 07:00-19:00"]
      },
      {
        vendor_id: "V005",
        company_name: "Bright Spark Electrical",
        primary_trade: "ELECTRICAL",
        phone: "555-0202",
        availability: ["Monday 09:00-17:00", "Wednesday 09:00-17:00", "Friday 09:00-17:00"]
      },
      {
        vendor_id: "V006",
        company_name: "CoolBreeze HVAC",
        primary_trade: "HVAC",
        phone: "555-0301",
        availability: ["Monday 08:00-18:00", "Tuesday 08:00-18:00", "Wednesday 08:00-18:00", "Friday 08:00-18:00"]
      },
      {
        vendor_id: "V007",
        company_name: "ComfortZone Heating & Cooling",
        primary_trade: "HVAC",
        phone: "555-0302",
        availability: ["Monday 09:00-17:00", "Thursday 09:00-17:00", "Friday 09:00-17:00"]
      },
      {
        vendor_id: "V008",
        company_name: "AllFix General Maintenance",
        primary_trade: "GENERAL",
        phone: "555-0401",
        availability: ["Monday 08:00-17:00", "Tuesday 08:00-17:00", "Wednesday 08:00-17:00", "Thursday 08:00-17:00", "Friday 08:00-17:00"]
      }
    ];

    // Elements
    const descriptionEl = document.getElementById('description');
    const locationEl = document.getElementById('location');
    const locationLatEl = document.getElementById('location-lat');
    const locationLonEl = document.getElementById('location-lon');
    const locationTextInput = document.getElementById('location-text-input');
    const locationCoordsInput = document.getElementById('location-coords-input');
    const locationStatusEl = document.getElementById('location-status');
    const toggleText = document.getElementById('toggle-text');
    const toggleGps = document.getElementById('toggle-gps');
    const apiUrlEl = document.getElementById('api-url');

    const step1Panel = document.getElementById('step1-panel');
    const step2Panel = document.getElementById('step2-panel');
    const step3Panel = document.getElementById('step3-panel');
    const triageResultsEl = document.getElementById('triage-results');

    const step1Indicator = document.getElementById('step1-indicator');
    const step2Indicator = document.getElementById('step2-indicator');
    const step3Indicator = document.getElementById('step3-indicator');

    const submitStep1Btn = document.getElementById('submit-step1');
    const submitStep2Btn = document.getElementById('submit-step2');
    const startOverBtn = document.getElementById('start-over');

    const step1StatusEl = document.getElementById('step1-status');
    const step2StatusEl = document.getElementById('step2-status');

    const time1El = document.getElementById('time1');
    const time2El = document.getElementById('time2');
    const time3El = document.getElementById('time3');

    // Quotation elements
    const quoteRequestIdEl = document.getElementById('quote-request-id');
    const quoteVendorIdEl = document.getElementById('quote-vendor-id');
    const quoteVendorNotesEl = document.getElementById('quote-vendor-notes');
    const quoteImagesEl = document.getElementById('quote-images');
    const quoteSubmitBtn = document.getElementById('quote-submit-btn');
    const quoteSubmitStatus = document.getElementById('quote-submit-status');
    const quoteSubmitResult = document.getElementById('quote-submit-result');
    const quoteResultId = document.getElementById('quote-result-id');
    const quoteResultPrice = document.getElementById('quote-result-price');
    const quoteResultTimeline = document.getElementById('quote-result-timeline');
    const quoteResultWarranty = document.getElementById('quote-result-warranty');

    const compareRequestIdEl = document.getElementById('compare-request-id');
    const compareId1El = document.getElementById('compare-id-1');
    const compareId2El = document.getElementById('compare-id-2');
    const compareId3El = document.getElementById('compare-id-3');
    const compareBtn = document.getElementById('compare-btn');
    const compareStatus = document.getElementById('compare-status');
    const compareResult = document.getElementById('compare-result');
    const compareRecommend = document.getElementById('compare-recommend');
    const compareSummary = document.getElementById('compare-summary');
    const compareFlags = document.getElementById('compare-flags');

    const quoteStoredList = document.getElementById('quote-stored-list');
    const quoteListBody = document.getElementById('quote-list-body');

    // Location functions
    function setLocationMode(mode) {
      locationMode = mode;
      toggleText.classList.toggle('active', mode === 'text');
      toggleGps.classList.toggle('active', mode === 'gps');
      locationTextInput.style.display = mode === 'text' ? 'block' : 'none';
      locationCoordsInput.style.display = mode === 'gps' ? 'block' : 'none';

      if (mode === 'gps') {
        requestGeolocation();
      } else {
        locationStatusEl.style.display = 'none';
      }
    }

    function requestGeolocation() {
      if (!navigator.geolocation) {
        showLocationStatus('Geolocation not supported', 'error');
        return;
      }
      showLocationStatus('Getting your location...', 'loading');

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          locationLatEl.value = pos.coords.latitude.toFixed(6);
          locationLonEl.value = pos.coords.longitude.toFixed(6);
          showLocationStatus('Location found!', 'success');
        },
        (err) => {
          showLocationStatus(err.code === 1 ? 'Permission denied' : 'Could not get location', 'error');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function showLocationStatus(msg, type) {
      locationStatusEl.style.display = 'block';
      locationStatusEl.textContent = msg;
      locationStatusEl.style.color = type === 'success' ? 'var(--accent-2)' : type === 'error' ? 'var(--danger)' : 'var(--muted)';
    }

    function getLocationData() {
      if (locationMode === 'text' && locationEl.value.trim()) {
        return { query: locationEl.value.trim() };
      } else if (locationMode === 'gps' && locationLatEl.value && locationLonEl.value) {
        return { latitude: parseFloat(locationLatEl.value), longitude: parseFloat(locationLonEl.value) };
      }
      return null;
    }

    toggleText.addEventListener('click', () => setLocationMode('text'));
    toggleGps.addEventListener('click', () => setLocationMode('gps'));

    // Step 1: Submit description
    submitStep1Btn.addEventListener('click', async () => {
      const description = descriptionEl.value.trim();
      if (!description) {
        step1StatusEl.textContent = 'Please describe the issue';
        step1StatusEl.className = 'status error';
        return;
      }

      submitStep1Btn.disabled = true;
      step1StatusEl.textContent = 'Analyzing...';
      step1StatusEl.className = 'status';

      const body = { description };
      const loc = getLocationData();
      if (loc) body.location = loc;

      try {
        const res = await fetch(`${apiUrlEl.value}/triage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');

        triageData = data;
        currentTrade = data.triage?.trade || 'GENERAL';

        // Update results
        document.getElementById('result-severity').textContent = data.triage?.severity || '--';
        document.getElementById('result-severity').className = 'pill ' + (data.triage?.severity || '').toLowerCase();
        document.getElementById('result-trade').textContent = data.triage?.trade || '--';
        document.getElementById('result-reasoning').textContent = data.triage?.reasoning || 'No details';
        document.getElementById('result-priority').textContent = 'Score: ' + (data.priority?.priority_score ?? '--');
        document.getElementById('result-sla').textContent = `Response: ${data.sla?.response_hours ?? '--'}h | Resolution: ${data.sla?.resolution_hours ?? '--'}h`;
        document.getElementById('detected-trade').textContent = currentTrade;

        // Show step 2
        triageResultsEl.classList.remove('hidden');
        step2Panel.classList.remove('hidden');
        step1Indicator.className = 'step done';
        step2Indicator.className = 'step active';
        step1StatusEl.textContent = '';

        step2Panel.scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        step1StatusEl.textContent = 'Error: ' + err.message;
        step1StatusEl.className = 'status error';
      } finally {
        submitStep1Btn.disabled = false;
      }
    });

    // Step 2: Submit time slots
    submitStep2Btn.addEventListener('click', async () => {
      const times = [time1El.value.trim(), time2El.value.trim(), time3El.value.trim()].filter(t => t);

      if (times.length < 1) {
        step2StatusEl.textContent = 'Please enter at least one time slot';
        step2StatusEl.className = 'status error';
        return;
      }

      submitStep2Btn.disabled = true;
      step2StatusEl.textContent = 'Finding best vendors...';
      step2StatusEl.className = 'status';

      try {
        const res = await fetch(`${apiUrlEl.value}/assign-vendors`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            trade: currentTrade,
            tenant_preferred_times: times,
            vendors: mockVendors  // In production, this comes from backend
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');

        renderVendorResults(data, times);

        // Show step 3
        step3Panel.classList.remove('hidden');
        step2Indicator.className = 'step done';
        step3Indicator.className = 'step done';
        step2StatusEl.textContent = '';

        step3Panel.scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        step2StatusEl.textContent = 'Error: ' + err.message;
        step2StatusEl.className = 'status error';
      } finally {
        submitStep2Btn.disabled = false;
      }
    });

    // Render vendors
    function renderVendorResults(data, tenantTimes) {
      const vendors = data.assigned_vendors || [];
      const summaryEl = document.getElementById('vendor-summary');
      const listEl = document.getElementById('vendor-list');

      if (!data.success || vendors.length === 0) {
        summaryEl.textContent = data.error || 'No vendors found for this trade.';
        listEl.innerHTML = '';
        return;
      }

      summaryEl.innerHTML = `
        Found <strong>${data.total_available}</strong> ${data.trade} vendors.
        Matched based on your availability:
        ${tenantTimes.map(t => `<span class="time-badge">${esc(t)}</span>`).join('')}
      `;

      listEl.innerHTML = vendors.map((v, i) => {
        const vendor = v.vendor;
        const isPrimary = v.role === 'primary';
        const matched = v.matched_times || [];

        return `
          <div class="vendor-card ${isPrimary ? 'primary' : ''}">
            <div class="vendor-header">
              <div>
                <div class="vendor-name">${isPrimary ? 'ü•á ' : i === 1 ? 'ü•à ' : 'ü•â '}${esc(vendor.company_name)}</div>
                <div class="muted" style="font-size: 13px; margin-top: 4px;">üìû ${esc(vendor.phone || 'N/A')}</div>
              </div>
              <span class="vendor-badge ${v.role}">${v.role.toUpperCase()}</span>
            </div>
            <div class="time-slots">
              <label>Matched Time Slots:</label>
              <div>
                ${matched.length > 0
                  ? matched.map(t => `<span class="time-badge">${esc(t)}</span>`).join('')
                  : '<span class="no-match">‚ö†Ô∏è No matching times - may need to coordinate</span>'
                }
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Quotation helpers
    function renderStoredQuotations() {
      if (!storedQuotations.length) {
        quoteStoredList.style.display = 'none';
        quoteListBody.innerHTML = '';
        return;
      }
      quoteStoredList.style.display = 'block';
      quoteListBody.innerHTML = storedQuotations.map(q => {
        const price = q.extracted_data?.total_price != null ? `$${q.extracted_data.total_price}` : 'n/a';
        const timeline = q.extracted_data?.timeline_description || (q.extracted_data?.timeline_days ? `${q.extracted_data.timeline_days} days` : 'n/a');
        return `<div>‚Ä¢ <strong>${esc(q.quotation_id)}</strong> | req ${esc(q.request_id)} | vendor ${esc(q.vendor_id)} | price ${esc(price)} | timeline ${esc(timeline)}</div>`;
      }).join('');
    }

    function updateComparisonFieldsDefaults(requestId) {
      if (requestId) {
        compareRequestIdEl.value = requestId;
      }
      if (storedQuotations.length >= 3) {
        compareId1El.value = storedQuotations[storedQuotations.length - 3].quotation_id;
        compareId2El.value = storedQuotations[storedQuotations.length - 2].quotation_id;
        compareId3El.value = storedQuotations[storedQuotations.length - 1].quotation_id;
      }
    }

    function fileListToBase64(fileList) {
      const files = Array.from(fileList || []);
      return Promise.all(files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      })));
    }

    // Submit quotation
    quoteSubmitBtn.addEventListener('click', async () => {
      const requestId = quoteRequestIdEl.value.trim();
      const vendorId = quoteVendorIdEl.value.trim();
      const notes = quoteVendorNotesEl.value.trim();
      const files = quoteImagesEl.files;

      if (!requestId || !vendorId) {
        quoteSubmitStatus.textContent = 'Request ID and Vendor ID are required.';
        quoteSubmitStatus.className = 'status error';
        return;
      }
      if (!files || files.length === 0) {
        quoteSubmitStatus.textContent = 'Please attach at least one image.';
        quoteSubmitStatus.className = 'status error';
        return;
      }

      quoteSubmitBtn.disabled = true;
      quoteSubmitStatus.textContent = 'Uploading & analyzing...';
      quoteSubmitStatus.className = 'status';

      try {
        const base64Images = await fileListToBase64(files);
        const res = await fetch(`${apiUrlEl.value}/quotation/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            request_id: requestId,
            vendor_id: vendorId,
            vendor_notes: notes || undefined,
            images: base64Images
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');

        quoteSubmitStatus.textContent = 'Quotation analyzed successfully.';
        quoteSubmitStatus.className = 'status success';

        // Show result
        quoteSubmitResult.style.display = 'block';
        quoteResultId.textContent = `Quotation ID: ${data.quotation_id}`;
        quoteResultPrice.textContent = `Total Price: ${data.extracted_data?.total_price ?? 'n/a'} ${data.extracted_data?.currency || ''}`.trim();
        quoteResultTimeline.textContent = `Timeline: ${data.extracted_data?.timeline_description || data.extracted_data?.timeline_days || 'n/a'}`;
        quoteResultWarranty.textContent = `Warranty: ${data.extracted_data?.warranty_description || data.extracted_data?.warranty_months || 'n/a'}`;

        // Store locally
        storedQuotations.push({
          quotation_id: data.quotation_id,
          request_id: requestId,
          vendor_id: vendorId,
          extracted_data: data.extracted_data || {}
        });
        renderStoredQuotations();
        updateComparisonFieldsDefaults(requestId);
      } catch (err) {
        quoteSubmitStatus.textContent = `Error: ${err.message}`;
        quoteSubmitStatus.className = 'status error';
      } finally {
        quoteSubmitBtn.disabled = false;
      }
    });

    // Compare quotations
    compareBtn.addEventListener('click', async () => {
      const requestId = compareRequestIdEl.value.trim();
      const ids = [compareId1El.value.trim(), compareId2El.value.trim(), compareId3El.value.trim()].filter(Boolean);

      if (!requestId) {
        compareStatus.textContent = 'Request ID is required.';
        compareStatus.className = 'status error';
        return;
      }
      if (ids.length !== 3) {
        compareStatus.textContent = 'Please enter exactly 3 quotation IDs.';
        compareStatus.className = 'status error';
        return;
      }

      compareBtn.disabled = true;
      compareStatus.textContent = 'Comparing...';
      compareStatus.className = 'status';

      // Build vendor name map from stored quotations if available
      const vendorNames = {};
      storedQuotations.forEach(q => {
        if (ids.includes(q.quotation_id)) {
          vendorNames[q.vendor_id] = q.vendor_id; // minimal; could be enhanced
        }
      });

      try {
        const res = await fetch(`${apiUrlEl.value}/quotation/compare`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            request_id: requestId,
            quotation_ids: ids,
            vendor_names: Object.keys(vendorNames).length ? vendorNames : undefined
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');

        compareStatus.textContent = 'Comparison complete.';
        compareStatus.className = 'status success';

        compareResult.style.display = 'block';
        const rec = data.comparison?.recommendation || {};
        const summary = data.comparison?.summary || {};
        compareRecommend.textContent = `Recommended Vendor: ${rec.recommended_vendor_id || 'n/a'} (confidence ${(rec.confidence ?? data.confidence ?? 0).toFixed(2)})`;
        compareSummary.textContent = `Price range: ${summary.price_range ? `$${summary.price_range.min} - $${summary.price_range.max}` : 'n/a'} | Lowest: ${summary.lowest_price || 'n/a'} | Fastest: ${summary.fastest_timeline || 'n/a'} | Best warranty: ${summary.best_warranty || 'n/a'}`;
        const flags = data.comparison?.red_flags || [];
        compareFlags.textContent = flags.length ? `Red flags: ${flags.join(', ')}` : 'No red flags.';

      } catch (err) {
        compareStatus.textContent = `Error: ${err.message}`;
        compareStatus.className = 'status error';
        compareResult.style.display = 'none';
      } finally {
        compareBtn.disabled = false;
      }
    });

    // Start over
    startOverBtn.addEventListener('click', () => location.reload());

    // Escape HTML
    function esc(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
